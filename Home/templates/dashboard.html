{% extends 'base2.html' %} {% load static %} {% block title %} Dashboard
{%endblock %} {% block content %}
<body
  class="hold-transition light-mode sidebar-mini layout-fixed layout-navbar-fixed layout-footer-fixed"
>
  <div class="wrapper">
    <div class="content-wrapper">
      <!-- Content Header (Page header) -->
      <section class="content-header">
        <div class="container-fluid">
          <div class="row mb-2">
            <div class="col-sm-6">
              <h1>Meta scrapy</h1>
            </div>
            <div class="col-sm-6">
              <ol class="breadcrumb float-sm-right">
                <li class="breadcrumb-item"><a href="#">Dashboard</a></li>
                <li class="breadcrumb-item active">Meta scrapy</li>
              </ol>
            </div>
          </div>
        </div>
        <!-- /.container-fluid -->
      </section>

      <!-- Main content -->
      <section class="content">
        <div class="container-fluid">
          <div class="row">
            <div class="col-12">
            {% if messages %}
            <div>
                {% for message in messages %}
                <div
                    {% if message.tags %} class="alert alert-borderless alert-warning text-center mb-2 mx-2" {% endif %}>
                    {% if message.level == DEFAULT_MESSAGE_LEVELS.ERROR %}{% endif %}
                    {{ message }}
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
            <div class="col-12">
              <form
                action="{% url 'add_product' %}"
                method="post"
                enctype="multipart/form-data"
              >
                {% csrf_token %}
                <div class="form-group row">
                  <div class="col-sm-12">
                    <small
                      >click on this button to start Publish all the ads in
                      below table
                    </small>
                    <br />
                    <a
                      href="{% url 'scraper' %}"
                      type="button"
                      class="btn btn-success mt-2"
                    >
                      Publish Ads On Market Place
                    </a>
                  </div>
                </div>

                <div class="form-group row">
                    <div class="col-sm-12">
                      <small
                        >Upload Excel file to add ads records in system
                      </small>
                    </div>
                    <div class="col-sm-4 mt-2">
                      <input
                        type="file"
                        name="myfile"
                        class="form-control"
                        value="Import File"
                        style="padding-bottom: 36px"
                        required
                      />
                    </div>
                    <div class="col-sm-2 mt-2">
                      <input
                        type="submit"
                        class="btn btn-info mt-1"
                        value="Upload Ads "
                      />
                    </div>
                  </div>
              </form>

              <form
                action="{% url 'upload_images' %}"
                method="post"
                enctype="multipart/form-data"
              >
                {% csrf_token %}
              <div class="form-group row">
                <div class="col-sm-12">
                  <small>
                    Upload Images (Images will be assigned in order: First image â†’ First product in table)
                  </small>
                  <br>
                  <small class="text-danger">
                    <b>Important:</b> If you have many products, upload images in smaller batches (10-15 at a time).
                  </small>
                </div>
                <div class="col-sm-4 mt-2">
                  <input
                    type="file"
                    name="product_images"
                    class="form-control"
                    value="Import File"
                    style="padding-bottom: 36px"
                    required
                    multiple
                    accept="image/jpeg,image/jpg,image/png"
                  />
                </div>
                <div class="col-sm-2 mt-2">
                  <input
                    type="submit"
                    class="btn btn-primary mt-1"
                    value="Upload Ads Images"
                  />
                </div>
              </div>
            </form>
            
            <script>
              document.addEventListener('DOMContentLoaded', function() {
                const uploadForm = document.getElementById('batch-upload-form');
                const uploadBtn = document.getElementById('batch-upload-btn');
                const fileInput = document.getElementById('batch-file-input');
                const progressDiv = document.getElementById('upload-progress');
                const progressBar = document.getElementById('upload-progress-bar');
                const statusText = document.getElementById('upload-status');
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                
                if (uploadBtn) {
                  uploadBtn.addEventListener('click', function() {
                    const files = fileInput.files;
                    if (files.length === 0) {
                      alert('Please select images to upload');
                      return;
                    }
                    
                    // Show progress
                    progressDiv.style.display = 'block';
                    uploadBtn.disabled = true;
                    
                    // Process in batches of 10 files
                    const BATCH_SIZE = 10;
                    const totalFiles = files.length;
                    let processed = 0;
                    
                    // Function to process each batch
                    function processBatch(startIdx) {
                      statusText.textContent = `Uploading batch ${Math.floor(startIdx/BATCH_SIZE) + 1} of ${Math.ceil(totalFiles/BATCH_SIZE)}...`;
                      
                      // Create FormData for this batch
                      const formData = new FormData();
                      formData.append('csrfmiddlewaretoken', csrfToken);
                      
                      // Add this batch of files
                      const endIdx = Math.min(startIdx + BATCH_SIZE, totalFiles);
                      for (let i = startIdx; i < endIdx; i++) {
                        formData.append('product_images', files[i]);
                      }
                      
                      // Send this batch
                      fetch(uploadForm.action, {
                        method: 'POST',
                        body: formData,
                        credentials: 'same-origin'
                      })
                      .then(response => {
                        // Update progress
                        processed += (endIdx - startIdx);
                        const percentComplete = Math.round((processed / totalFiles) * 100);
                        progressBar.style.width = percentComplete + '%';
                        
                        // Process next batch or finish
                        if (processed < totalFiles) {
                          processBatch(endIdx);
                        } else {
                          statusText.textContent = 'Upload complete! Refreshing page...';
                          setTimeout(function() {
                            window.location.reload();
                          }, 1000);
                        }
                      })
                      .catch(error => {
                        console.error('Error:', error);
                        statusText.textContent = 'Error during upload. Please try again.';
                        uploadBtn.disabled = false;
                      });
                    }
                    
                    // Start the first batch
                    processBatch(0);
                  });
                }
              });
            </script>
              <div class="card">
                <div class="card-header">
                  <small
                    ><a
                      class="btn btn-danger bi bi-trash text-white"
                      id="delete_btn"
                      ><span class="glyphicon glyphicon-trash"></span> Delete</a
                    ></small
                  >
                <small>  (Select items and click on delete button to delete items)</small>
                </div>
                <!-- /.card-header -->
                <div class="card-body">
                  <table id="example1" class="table table-bordered table-hover">
                    <thead style="background-color: #007bff" class="text-white">
                      <tr>
                        <th>  <input
                            type="checkbox"
                            id="select_all"
                            title="Select All"
                          /></th>
                          <th>ID</th>
                        <th>Title</th>
                        <th>Price</th>

                        <th>Location</th>
                        <th>Description</th>
                        <th>Tags</th>
                        <th>Image</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for item in product_data %}
                      <tr id="{{ item.id }}">
                        <td data-th="Select">
                          <input
                            type="checkbox"
                            name="sel"
                            value="{{ item.id }}"
                            class="select-item"
                          />
                        </td>
                        <td>{{ item.id }}</td>
                        <td>{{ item.title }}</td>
                        <td>{{ item.price }}</td>

                        <td>{{ item.location }}</td>
                        <td>{{ item.desc }}</td>
                        <td>
                          {{ item.tag1 }} &nbsp; {{ item.tag2 }}&nbsp; {{
                          item.tag3 }}&nbsp; {{ item.tag4 }}&nbsp; {{ item.tag5
                          }}
                        </td>

                        <td>
                          {% if item.image %}
                          <img
                            src="{{ item.image.url }}"
                            class="user-image img-circle elevation-2"
                            alt="User profile picture"
                            height="70px"
                            width="70px"
                          />
                          {% else %}
                          <form
                            action="{% url 'add_image'  %}"
                            method="post"
                            enctype="multipart/form-data"
                          >
                            {% csrf_token %}
                            <div class="form-group row">
                              <div class="col-sm-8">
                                <input
                                  type="file"
                                  name="product_image"
                                  value="Image"
                                />
                              </div>

                              <input
                                type="hidden"
                                name="product_pk"
                                class="form-control"
                                value="{{ item.id }}"
                              />

                              <div class="col-sm-2">
                                <input
                                  type="submit"
                                  class="btn btn-sm btn-primary"
                                  value="Upload"
                                />
                              </div>
                            </div>
                          </form>
                          {% endif %}
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
                <!-- /.card-body -->
              </div>
            </div>
            <!-- /.col -->
          </div>
          <!-- /.row -->
        </div>
        <!-- /.container-fluid -->
      </section>
      <!-- /.content -->
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
  <script>
     // Select/Deselect all checkboxes
  document.getElementById("select_all").addEventListener("change", function () {
    const checkboxes = document.querySelectorAll(".select-item");
    checkboxes.forEach((checkbox) => {
      checkbox.checked = this.checked;
    });
  });
    $(function () {
      $("#example1")
        .DataTable({
          responsive: true,
          lengthChange: false,
          autoWidth: true,
          buttons: ["copy", "csv", "excel", "pdf", "print", "colvis"],
        })
        .buttons()
        .container()
        .appendTo("#example1_wrapper .col-md-6:eq(0)");
      $("#example2").DataTable({
        paging: true,
        lengthChange: false,
        searching: false,
        ordering: true,
        info: true,
        autoWidth: true,
        responsive: true,
      });
    });
  </script>

  <script>
    $(document).ready(function () {
        $('#delete_btn').click(function () {
            if (confirm("Are you sure you want to delete selected?")) {
                var id = [];
                var csrf = $('input[name=csrfmiddlewaretoken] ').val();
                $(':checkbox:checked').map(function (i) {
                    id[i] = $(this).val()
                })
                if (id.length === 0) {
                    alert("Please select checkboxes to delete")
                } else {
                    $.ajax({
                        url: '{% url 'delete_product' %}',
                        method: "POST",
                        headers: {'X-CSRFToken': '{{ csrf_token }}'},
                        data: {
                            id
                        },
                        success: function (response) {
                            for (var i = 0; i < id.length; i++) {
                                $('tr#' + id[i] + '').css('background-color', '#ccc');
                                $('tr#' + id[i] + '').fadeOut('slow');
                            }
                            location.reload();
                        }
                    })
                }
            }
        })
    });
  </script>
</body>

{% endblock %}
